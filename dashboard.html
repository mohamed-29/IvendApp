<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ivend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .header-logo { font-size: 2rem; font-weight: 700; color: #F97300; letter-spacing: -1.5px; }
        .collapsible-content { transition: max-height 0.5s ease-in-out; max-height: 0; overflow: hidden; }
        .modal, .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="header-logo">ivend</div>
            <div class="flex items-center">
                <span class="text-gray-700 mr-4 hidden sm:inline">Welcome, {{ user.username }}!</span>
                
                <!-- Notification Bell -->
                <div class="relative mr-4">
                    <button id="notification-bell-btn" class="relative text-gray-600 hover:text-gray-800 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-5-5.917V5a1 1 0 10-2 0v.083A6 6 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 text-white text-xs flex items-center justify-center hidden">0</span>
                    </button>
                    <!-- Notification Dropdown Panel -->
                    <div id="notification-panel" class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg overflow-hidden z-20 hidden">
                        <div class="py-2 px-4 font-bold text-gray-700 border-b">Notifications</div>
                        <div id="notification-list" class="max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-sm p-4">No new notifications.</p>
                        </div>
                    </div>
                </div>

                <a href="{% url 'logout' %}" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Logout</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center"><div class="bg-blue-500 text-white rounded-full p-3 mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg></div><div><p class="text-sm text-gray-500">Total Machines</p><p id="total-machines-count" class="text-2xl font-bold text-gray-800">0</p></div></div>
            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center"><div class="bg-green-500 text-white rounded-full p-3 mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><p class="text-sm text-gray-500">Online</p><p id="online-machines-count" class="text-2xl font-bold text-green-600">0</p></div></div>
            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center"><div class="bg-red-500 text-white rounded-full p-3 mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg></div><div><p class="text-sm text-gray-500">Offline</p><p id="offline-machines-count" class="text-2xl font-bold text-red-600">0</p></div></div>
            <div id="shortage-card" class="bg-white p-6 rounded-lg shadow-lg flex items-center cursor-pointer hover:bg-gray-50 transition-colors"><div class="bg-yellow-500 text-white rounded-full p-3 mr-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><div><p class="text-sm text-gray-500">Products to Restock</p><p id="shortage-products-count" class="text-2xl font-bold text-yellow-600">0</p></div></div>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 mb-6">Machine Details</h1>
        
        <div id="machine-data-container" class="space-y-4">
            <div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-gray-600">Loading machine data...</p></div>
        </div>
    </main>

    <!-- Shortage Modal -->
    <div id="shortage-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-30 hidden opacity-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6"><div class="flex justify-between items-center border-b pb-3 mb-4"><h2 class="text-2xl font-bold text-gray-800">Products to Restock</h2><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div id="shortage-list" class="max-h-96 overflow-y-auto"></div></div>
    </div>
    
    <!-- Notification Toast Container -->
    <div id="notification-container" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>

    <script>
        let shortageProductsList = [];
        let allNotifications = [];
        let unreadNotificationCount = 0;

        function timeAgo(dateString) {
            if (!dateString) return 'never';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            if (seconds < 60) return "just now";
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.round(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.round(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        // --- NOTIFICATION FUNCTIONS ---
        function showToast(message) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md shadow-lg flex items-start transform translate-x-full opacity-0';
            toast.innerHTML = `<div><p class="font-bold">Low Stock Alert</p><p>${message}</p></div><button class="ml-auto -mr-2 -mt-2 text-yellow-500 hover:text-yellow-700">&times;</button>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 100);
            const closeButton = toast.querySelector('button');
            const closeToast = () => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); };
            closeButton.onclick = closeToast;
            setTimeout(closeToast, 10000);
        }

        function renderNotificationPanel() {
            const listContainer = document.getElementById('notification-list');
            if (allNotifications.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm p-4">No new notifications.</p>';
                return;
            }
            const listHtml = allNotifications.map(notif => `
                <div class="p-3 border-b hover:bg-gray-50">
                    <p class="text-sm text-gray-800">${notif.message}</p>
                    <p class="text-xs text-gray-400 mt-1">${timeAgo(notif.timestamp)}</p>
                </div>
            `).join('');
            listContainer.innerHTML = listHtml;
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            badge.textContent = unreadNotificationCount;
            badge.classList.toggle('hidden', unreadNotificationCount === 0);
        }

        function connectToNotificationStream() {
            const eventSource = new EventSource('/api/notifications/');
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                showToast(data.message);
                allNotifications.unshift({ message: data.message, timestamp: new Date() });
                unreadNotificationCount++;
                updateNotificationBadge();
                renderNotificationPanel();
            };
            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                eventSource.close();
                setTimeout(connectToNotificationStream, 5000);
            };
        }

        // --- GENERAL EVENT LISTENERS ---
        function addEventListeners() {
            document.querySelectorAll('.machine-toggle-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const content = document.getElementById(targetId);
                    const icon = header.querySelector('.chevron-icon');
                    if (!content.dataset.loaded) {
                        fetchProductsForMachine(header.dataset.machineId, header.dataset.machineName);
                    }
                    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                        content.style.maxHeight = '0px';
                        icon.classList.remove('rotate-180');
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                });
            });

            const shortageCard = document.getElementById('shortage-card');
            const shortageModal = document.getElementById('shortage-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            shortageCard.addEventListener('click', () => {
                renderShortageModal();
                shortageModal.classList.remove('hidden');
                setTimeout(() => shortageModal.classList.remove('opacity-0'), 10);
            });
            const closeModal = () => {
                shortageModal.classList.add('opacity-0');
                setTimeout(() => shortageModal.classList.add('hidden'), 250);
            };
            closeModalBtn.addEventListener('click', closeModal);
            shortageModal.addEventListener('click', (e) => { if(e.target === shortageModal) closeModal(); });
            
            const bellBtn = document.getElementById('notification-bell-btn');
            const notificationPanel = document.getElementById('notification-panel');
            bellBtn.addEventListener('click', () => {
                notificationPanel.classList.toggle('hidden');
                if (!notificationPanel.classList.contains('hidden')) {
                    unreadNotificationCount = 0;
                    updateNotificationBadge();
                }
            });
            document.addEventListener('click', (e) => {
                if (!bellBtn.contains(e.target) && !notificationPanel.contains(e.target)) {
                    notificationPanel.classList.add('hidden');
                }
            });
        }
        
        function renderShortageModal() {
            const listContainer = document.getElementById('shortage-list');
            if (shortageProductsList.length === 0) {
                 listContainer.innerHTML = '<p class="text-gray-600">All products are well-stocked!</p>';
                 return;
            }
            const listHtml = shortageProductsList.map(item => `<div class="py-3 border-b last:border-0"><p class="font-semibold text-gray-800">${item.name}</p><div class="flex justify-between items-center text-sm text-gray-600 mt-1"><span>Machine: <strong>${item.machine_name}</strong></span><span>Tray: <strong>${item.tray_number}</strong></span><span class="font-bold text-red-600">Stock: ${item.available_qty}</span></div></div>`).join('');
            listContainer.innerHTML = listHtml;
        }
        
        async function fetchProductsForMachine(machineId, machineName) {
            const productContainer = document.querySelector(`#products-${machineId} ul`);
            productContainer.innerHTML = '<p class="text-gray-500">Loading products...</p>';
            try {
                const response = await fetch(`/api/machines/${machineId}/products/`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('Failed to load products');
                const products = await response.json();
                
                let productsHtml = '<p class="text-gray-500 mt-2">No product data for this machine.</p>';
                if (products && products.length > 0) {
                    productsHtml = products.map(product => {
                        const placeholderImg = 'https://placehold.co/48x48/FDF7E4/F97300?text=Ivend';
                        return `
                            <li class="flex items-center py-3 border-b border-gray-200 last:border-b-0">
                                <img src="${product.picture || placeholderImg}" alt="${product.name}" class="w-12 h-12 rounded-md object-contain mr-4 flex-shrink-0">
                                <div class="flex-grow">
                                    <p class="font-semibold text-gray-800">${product.name}</p>
                                    <p class="text-sm text-gray-500">Code: ${product.product_number || 'N/A'}</p>
                                </div>
                                <div class="flex items-center space-x-4 text-sm ml-4">
                                    <span class="text-gray-600 hidden sm:inline">Tray: <strong>${product.tray_number}</strong></span>
                                    <span class="text-gray-600"><strong>${product.sale_price} EGP</strong></span>
                                    <span class="px-2 py-1 text-xs font-semibold rounded ${product.available_qty <= 2 ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                        Stock: ${product.available_qty} / ${product.capacity}
                                    </span>
                                </div>
                            </li>
                        `;
                    }).join('');
                }
                productContainer.innerHTML = productsHtml;
                productContainer.parentElement.dataset.loaded = "true";
                const content = document.getElementById(`products-${machineId}`);
                if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            } catch (error) {
                productContainer.innerHTML = '<p class="text-red-500">Could not load products.</p>';
            }
        }

        function fetchAndRenderData() {
            fetch('/api/dashboard-stats/', { credentials: 'same-origin' })
                .then(res => res.json())
                .then(stats => {
                    document.getElementById('total-machines-count').textContent = stats.total_machines;
                    document.getElementById('online-machines-count').textContent = stats.online_machines;
                    document.getElementById('offline-machines-count').textContent = stats.offline_machines;
                    document.getElementById('shortage-products-count').textContent = stats.shortage_products_count;
                    shortageProductsList = stats.shortage_products;
                });

            fetch('/api/machines/', { credentials: 'same-origin' })
            .then(res => res.json())
            .then(machines => {
                const container = document.getElementById('machine-data-container');
                if (machines.length === 0) {
                     container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg text-center"><h2 class="text-xl font-semibold text-gray-700">No Vending Machines Found</h2><p class="text-gray-500 mt-2">There are no vending machines assigned to your user account.</p></div>`;
                     return;
                }
                const machinesHtml = machines.map(machine => `
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="p-4 flex justify-between items-center cursor-pointer machine-toggle-header" data-target="products-${machine.id}" data-machine-id="${machine.id}" data-machine-name="${machine.name}">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">${machine.name}</h2>
                                <div class="flex items-center space-x-2 text-xs text-gray-400 mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <span>Last updated: ${timeAgo(machine.last_update)}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${machine.temperature <= 15 ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${machine.temperature}Â°C
                                </span>
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${machine.is_online ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${machine.is_online ? 'Online' : 'Offline'}
                                </span>
                                <svg class="chevron-icon w-5 h-5 text-gray-500 transition-transform transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                        <div id="products-${machine.id}" class="collapsible-content px-4 pb-4">
                            <ul class="space-y-1"></ul>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = machinesHtml;
                addEventListeners();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchAndRenderData();
            connectToNotificationStream();
            setInterval(fetchAndRenderData, 60000); 
        });
    </script>

</body>
</html>

